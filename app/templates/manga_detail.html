{# app/templates/manga_detail.html #}
{% extends "base.html" %}

{% block title %}{{ manga.TitleEn }} | MangaDex Clone{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manga_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/comments.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_to_list.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<div class="manga-detail-container">
    <div class="manga-main">
        <!-- Header Section -->
        <div class="manga-detail-header" data-cover-url="{{ manga_cover_url }}">
            <div class="manga-cover-thumbnail">
                <img src="{{ manga_cover_url }}" alt="Cover of {{ manga.TitleEn }}" class="cover-img">
            </div>
            <div class="manga-info">
                <h1 class="manga-title">{{ manga.TitleEn }}</h1>
                <div class="manga-actions">
                    <a href="#" class="btn btn-primary add-to-list" data-manga-id="{{ manga.MangaId }}">
                        Add To Library
                    </a>
                    {% if has_chapters %}
                    <button id="start-reading" class="btn btn-secondary" data-manga-id="{{ manga.MangaId }}">Start
                        Reading</button>
                    {% if is_authenticated %}
                    <button id="continue-reading" class="btn btn-info" data-manga-id="{{ manga.MangaId }}">Continue
                        Reading</button>
                    {% else %}
                    <button id="continue-reading-guest" class="btn btn-info">Continue Reading</button>
                    {% endif %}
                    {% else %}
                    <button class="btn btn-secondary disabled">No Chapters</button>
                    {% endif %}
                </div>
                <div class="manga-meta">
                    <span class="content-rating">{{ manga.ContentRating if manga.ContentRating else 'N/A' }}</span>
                    {% for tag in content_tags %}
                    <span class="tag-badge">{{ tag.NameEn }}</span>
                    {% endfor %}
                </div>
                <div class="manga-meta">
                    <span class="status-dot" data-status="{{ manga.Status | default('Unknown') }}"></span>
                    <span class="publication">
                        Publication: {{ manga.Year if manga.Year else 'N/A' }}, {{ manga.Status if manga.Status else
                        'N/A' }}
                    </span>
                </div>

                <!-- === UPDATED: Manga stats + Your rating widget === -->
                <div class="manga-stats">
                    <span class="stat-rating">
                        ⭐ {{ (manga_stats.AverageRating if manga_stats and manga_stats.AverageRating else
                        (manga_stats.BayesianRating if manga_stats else 0))|round(1) }}
                    </span>
                    <span class="stat-follows">
                        ❤️ {{ manga_stats.Follows if manga_stats and manga_stats.Follows else 0 }}
                    </span>

                    <div class="your-rating" data-manga-id="{{ manga.MangaId }}">
                        {% if is_authenticated %}
                        <label for="user-rating-select">Your score:</label>
                        <select id="user-rating-select" name="score" aria-label="Your score (1-10)">
                            <option value="">N/A</option>
                            {% for i in range(1,11) %}
                            <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                        <button id="user-rating-save" class="btn btn-success btn-sm">Save</button>
                        <button id="user-rating-remove" class="btn btn-outline-danger btn-sm"
                            style="display:none;">Remove</button>
                        <span id="user-rating-msg" class="rating-msg" aria-live="polite"></span>
                        {% else %}
                        <span class="please-login">
                            <a href="{{ url_for('auth.login') }}">Login to rate</a>
                        </span>
                        {% endif %}
                    </div>
                </div>
                <!-- === END UPDATED === -->

            </div>
        </div>

        <!-- Description Section -->
        <div class="manga-description">
            {{ manga_description|safe if manga_description else 'No description available' }}
        </div>

        <!-- Tabs Section -->
        <div class="manga-tabs">
            <a href="#chapters" class="tab active" data-tab="chapters">Chapters</a>
            <a href="#comments" class="tab" data-tab="comments">Comments</a>
            <a href="#art" class="tab" data-tab="art"
                data-url="{{ url_for('manga.manga_art', manga_id=manga.MangaId) }}">Art</a>
            <a href="#related" class="tab" data-tab="related">Related</a>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="chapters">
                {% if chapters %}
                <h2>Chapters</h2>
                <ul>
                    {% for chapter in chapters %}
                    <li>{{ chapter.Title }} - {{ chapter.ChapterNumber }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-center text-gray">This feature is under development.</p>
                {% endif %}
            </div>

            <div class="tab-pane" id="comments">
                {# Inline include: comments partial expects variables passed from manga_detail route:
                comments, comments_pagination, comments_sort, is_authenticated #}
                {% include 'comments.html' %}
            </div>

            <div class="tab-pane" id="art">
                <p class="text-center text-gray">This feature is under development.</p>
            </div>

            <div class="tab-pane" id="related">
                <p class="text-center text-gray">This feature is under development.</p>
            </div>
        </div>
    </div>

    <!-- Sidebar (unchanged) -->
    <div class="manga-sidebar">
        <div class="sidebar-section">
            <h3>Authors</h3>
            <ul class="tag-list">
                {% for author in authors %}
                {% if author %}
                <li><a href="{{ url_for('main.creator_detail', creator_id=author.CreatorId) }}" class="tag-link">{{
                        author.Name }}</a></li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Artists</h3>
            <ul class="tag-list">
                {% for artist in artists %}
                {% if artist %}
                <li><a href="{{ url_for('main.creator_detail', creator_id=artist.CreatorId) }}" class="tag-link">{{
                        artist.Name }}</a></li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Genres</h3>
            <ul class="tag-list">
                {% for tag in genres %}
                <li><a href="#" class="tag-link">{{ tag.NameEn }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Themes</h3>
            <ul class="tag-list">
                {% for tag in themes %}
                <li><a href="#" class="tag-link">{{ tag.NameEn }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Demographic</h3>
            <ul class="tag-list">
                <li><a href="#" class="tag-link">{{ manga.PublicationDemographic if manga.PublicationDemographic else
                        'N/A' }}</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Format</h3>
            <ul class="tag-list">
                {% for tag in formats %}
                <li><a href="#" class="tag-link">{{ tag.NameEn }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Track</h3>
            <ul class="track-list">
                {% for link in manga_links %}
                <li><a href="{{ link.Url }}" class="track-link" target="_blank">{{ link.ProviderFullName }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Alternative Titles</h3>
            <ul class="alt-title-list">
                {% for alt_title in alt_titles %}
                <li>
                    <img src="{{ url_for('static', filename='flags/' + alt_title.LangCode + '.png') }}"
                        alt="{{ alt_title.LangCode }} flag" class="flag-icon">
                    <span>{{ alt_title.AltTitle }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="lang-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Select Language</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="lang-form">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lang" id="en" value="en">
                        <label class="form-check-label" for="en">English</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lang" id="vi" value="vi">
                        <label class="form-check-label" for="vi">Vietnamese</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submit-lang">Start</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="no-chapter-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">No Chapters</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>No chapters available yet.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="login-required-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Login Required</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please login to use Continue Reading.</p>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary">Login</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='js/comments.js') }}"></script>
<script src="{{ url_for('static', filename='js/manga_detail.js') }}"></script>
<script src="{{ url_for('static', filename='js/add_to_list.js') }}"></script>
{% endblock %}